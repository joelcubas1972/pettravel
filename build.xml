<?xml version="1.0" encoding="UTF-8"?>
<project name="PetTravelDocs" default="dist" basedir=".">

    <!-- ===========================
         PROPIEDADES DEL PROYECTO
         =========================== -->
    <property name="src.dir" value="src"/>
    <property name="web.dir" value="web"/>
    <property name="build.dir" value="build"/>
    <property name="build.classes.dir" value="${build.dir}/classes"/>
    <property name="build.web.dir" value="${build.dir}/web"/>
    <property name="dist.dir" value="dist"/>
    
    <!-- Detectar si estamos en Render -->
    <condition property="render.env" value="true">
        <isset property="RENDER"/>
    </condition>

    <!-- ===========================
         CLASSPATH
         =========================== -->
    <path id="classpath">
        <fileset dir="${web.dir}/WEB-INF/lib" includes="**/*.jar"/>
        <!-- Solo incluir Tomcat si NO estamos en Render -->
        <fileset dir="${tomcat.home}/lib" includes="*.jar" erroronmissingdir="true">
            <not>
                <isset property="render.env"/>
            </not>
        </fileset>
    </path>

    <!-- ===========================
         CLEAN
         =========================== -->
    <target name="clean">
        <delete dir="${build.dir}"/>
        <delete dir="${dist.dir}"/>
        <mkdir dir="${build.dir}"/>
        <mkdir dir="${dist.dir}"/>
    </target>

    <!-- ===========================
         COMPILAR JAVA
         =========================== -->
    <target name="compile" depends="clean">
        <mkdir dir="${build.classes.dir}"/>
        <javac srcdir="${src.dir}" destdir="${build.classes.dir}"
               classpathref="classpath"
               includeantruntime="false"
               source="17" target="17"
               encoding="UTF-8">
            <compilerarg value="-parameters"/>
        </javac>
        <echo message="âœ… CompilaciÃ³n completada"/>
    </target>

    <!-- ===========================
         COPIAR RECURSOS WEB
         =========================== -->
    <target name="copy-resources" depends="compile">
        <mkdir dir="${build.web.dir}"/>
        
        <!-- Copiar TODO EXCEPTO WEB-INF/web.xml -->
        <copy todir="${build.web.dir}">
            <fileset dir="${web.dir}">
                <exclude name="WEB-INF/web.xml"/>
            </fileset>
        </copy>
        
        <!-- Copiar clases compiladas -->
        <copy todir="${build.web.dir}/WEB-INF/classes">
            <fileset dir="${build.classes.dir}"/>
        </copy>
        
        <!-- Copiar librerÃ­as -->
        <copy todir="${build.web.dir}/WEB-INF/lib">
            <fileset dir="${web.dir}/WEB-INF/lib"/>
        </copy>
        
        <!-- Copiar archivo web.xml por separado -->
        <copy file="${web.dir}/WEB-INF/web.xml" 
              tofile="${build.web.dir}/WEB-INF/web.xml"/>
    </target>

    <!-- ===========================
         GENERAR WAR
         =========================== -->
    <target name="war" depends="copy-resources">
        <mkdir dir="${dist.dir}"/>
        <war destfile="${dist.dir}/PetTravelDocs.war" webxml="${build.web.dir}/WEB-INF/web.xml">
            <fileset dir="${build.web.dir}"/>
        </war>
        <echo message="âœ… WAR generado: PetTravelDocs.war"/>
    </target>

    <!-- ===========================
         DIST - TAREA PRINCIPAL
         =========================== -->
    <target name="dist" depends="war">
        <echo message="âœ… Build completado"/>
    </target>

    <!-- ===========================
         TAREAS SOLO PARA LOCAL
         =========================== -->
    <target name="local-deploy" depends="dist" unless="render.env">
        <property name="tomcat.home" value="C:/apache-tomcat-11.0.6"/>
        <copy file="${dist.dir}/PetTravelDocs.war" 
              todir="${tomcat.home}/webapps" 
              overwrite="true"/>
        <echo message="âœ… WAR copiado a Tomcat local"/>
    </target>

    <target name="quick-deploy" depends="war" unless="render.env">
        <property name="tomcat.home" value="C:/apache-tomcat-11.0.6"/>
        <echo message="â¹ Deteniendo Tomcat..."/>
        <exec executable="${tomcat.home}/bin/shutdown.bat" osfamily="windows"/>
        <exec executable="${tomcat.home}/bin/shutdown.sh" osfamily="unix"/>
        <sleep seconds="3"/>
        <echo message="ðŸ“ Copiando WAR a Tomcat..."/>
        <copy file="${dist.dir}/PetTravelDocs.war" 
              todir="${tomcat.home}/webapps" 
              overwrite="true"/>
        <echo message="ðŸš€ Iniciando Tomcat..."/>
        <exec executable="${tomcat.home}/bin/startup.bat" osfamily="windows"/>
        <exec executable="${tomcat.home}/bin/startup.sh" osfamily="unix"/>
    </target>

    <!-- ===========================
         DEBUG (SOLO LOCAL)
         =========================== -->
    <target name="debug" depends="quick-deploy" unless="render.env">
        <property name="browser.cmd" value="C:/Program Files/Mozilla Firefox/firefox.exe"/>
        <exec executable="${browser.cmd}">
            <arg value="http://localhost:8080/PetTravelDocs/"/>
        </exec>
        <echo message="âœ… Proyecto desplegado localmente"/>
    </target>

</project>